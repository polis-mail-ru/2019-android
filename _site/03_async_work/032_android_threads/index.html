<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Потоки в Android | Android курс в Технополисе 2019</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="Потоки в Android" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/03_async_work/032_android_threads/" />
<meta property="og:url" content="http://localhost:4000/03_async_work/032_android_threads/" />
<meta property="og:site_name" content="Android курс в Технополисе 2019" />
<script type="application/ld+json">
{"url":"http://localhost:4000/03_async_work/032_android_threads/","headline":"Потоки в Android","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=d3418c91688b3f949df607a428f4549250f0b594">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">Android курс в Технополисе 2019</a></h1>
      

      <p>В этом уроке мы узнаем о потоках в <code class="highlighter-rouge">Android</code>.</p>

<h2 id="потоки">Потоки</h2>

<h3 id="обзор">Обзор</h3>

<p>Поток является набором команд исполняемого кода [приложения] (../031_android_processes/index.md), выполняемых последовательно. Каждому потоку, помимо всего прочего, при его создании выделяется память из адресного пространства [процесса] (../031_android_processes/index.md) приложения, которая называется стеком вызовов. Размер стека, как правило, равен ~1Мб.</p>

<p>Каждый поток существует в <code class="highlighter-rouge">рамках</code> процесса приложения, который его создал.</p>

<p>Память процесса приложения является общей для всех потоков процесса.</p>

<p>Количество потоков в процессе не ограничено (в пределах доступной памяти).</p>

<p>Потоки могут выполняться параллельно (одновременно) на разных процессорах (<code class="highlighter-rouge">CPU</code>) или ядрах.</p>

<p><img src="./img/Multithreaded_process.png" /></p>

<p>Потоку в языке программирования <code class="highlighter-rouge">Java</code> соответствует экземпляр (instance) класса [Thread] (https://developer.android.com/reference/java/lang/Thread.html).</p>

<p><img src="./img/thread_cpu_1.png" /></p>

<p>Для определения текущего потока, в классе [Thread] (https://developer.android.com/reference/java/lang/Thread.html) определён статический метод [currentThread()] (https://developer.android.com/reference/java/lang/Thread.html#currentThread()).</p>

<p>Поток начнёт выполняться <code class="highlighter-rouge">только</code> после вызова метода [start()] (https://developer.android.com/reference/java/lang/Thread.html#start()) у экземпляра (instance) класса [Thread] (https://developer.android.com/reference/java/lang/Thread.html).</p>

<p>Для того, что бы указать какой код должен исполняться потоком, его необходимо явно передать экземпляру класса <code class="highlighter-rouge">Thread</code>, например через анонимную имплементацию интерфейса [Runnable] (https://developer.android.com/reference/java/lang/Runnable.html):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="o">...</span>

    <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span>
        <span class="k">new</span> <span class="nf">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="c1">// do something</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>или через явную имплементацию интерфейса [Runnable] (https://developer.android.com/reference/java/lang/Runnable.html):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="o">...</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ThreadTask</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
        <span class="c1">// Этот метод будет выполнен в отдельном потоке</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">// do something</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="n">ThreadTask</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadTask</span><span class="o">();</span>
    <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">task</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>

    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>или, иcпользуя новые возможности языка ([Java 8, Android 7.0] (https://docs.oracle.com/javase/8/docs/api/java/util/function/package-summary.html)):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="o">...</span>
    
    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ThreadTask</span> <span class="o">{</span>
        <span class="c1">// Этот метод будет выполнен в отдельном потоке</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">doSomething</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">// ...</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="c1">// do something</span>
    <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

    <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="nl">ThreadTask:</span><span class="o">:</span><span class="n">doSomething</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>

    <span class="o">...</span>    
<span class="o">}</span>
</code></pre></div></div>

<h3 id="главный-основной-поток">Главный (основной) поток</h3>

<p>При создании [процесса] (../031_android_processes/index.md), <code class="highlighter-rouge">Android</code> автоматически создаёт <code class="highlighter-rouge">главный</code> поток (<code class="highlighter-rouge">Main Thread</code>) процесса и передаёт ему управление.</p>

<p><img src="./img/thread_cpu_2.png" /></p>

<p>Основные задачи, возлагаемые на главный поток (<code class="highlighter-rouge">Thread</code>) процесса:</p>

<ul>
  <li>отображение графического интерфейса приложения - <code class="highlighter-rouge">UI</code>, т.е. отрисовка</li>
  <li>обработка пользовательского ввода, т.е. события, приходящие от таких устройств как клавиатура, экран и т.д.</li>
</ul>

<p>В силу сказанного выше, главный поток процесса иногда называют потоком пользовательского интерфейса или <code class="highlighter-rouge">UI потоком</code>.</p>

<p>Ещё одной важной задачей, возлагаемой на главный поток, является задача обеспечения жизненного цикла компонентов Android приложения ([Activity] (https://developer.android.com/reference/android/app/Activity.html), [Service] (https://developer.android.com/reference/android/app/Service.html) и т.д.). Всякий раз, когда необходимо создать экземпляр компонента Android приложения ([Activity.onCreate] (https://developer.android.com/reference/android/app/Activity.html#onCreate(android.os.Bundle)), [Service.onCreate] (https://developer.android.com/reference/android/app/Service.html#onCreate()), …) или передать (диспетчировать) ему какое-либо событие для обработки, используется главный поток.</p>

<p>Пользовательский интерфейс Android приложения (<code class="highlighter-rouge">UI</code>), главным образом, базируется на классах, которые определены в [android.widget] (https://developer.android.com/reference/android/widget/package-summary.html) и [android.view] (https://developer.android.com/reference/android/view/package-summary.html) - <code class="highlighter-rouge">UI toolkit</code>.</p>

<p><code class="highlighter-rouge">UI toolkit</code> не является потокобезопасным. Другими словами, одновременный доступ из разных потоков к классам из <code class="highlighter-rouge">UI toolkit</code> не предусмотрен.</p>

<p>Поскольку UI приложения функционирует <code class="highlighter-rouge">в рамках</code> главного потока, то и все обращения (вызовы) к нему должны <code class="highlighter-rouge">перенаправляться</code> в этот поток.</p>

<p>Более того, обработка событий в конексте главного потока не должна занимать много времени дабы избежать видимых артефактов: медленное <code class="highlighter-rouge">обновление</code> графического интерфейса, задержки при обработке пользовательского ввода и т.д.</p>

<p>Android считает главный поток <code class="highlighter-rouge">заблокированным</code>, если обработка события занимает несколько секунд (как правило 5). В таком случае возникает [ANR] (http://developer.android.com/guide/practices/responsiveness.html).</p>

<p>Вообще, все методы в контексте главного потока должны выполняться в пределах ~16 миллисекунд (для обеспечения частоты обновления графического интерфеса в пределах 60-и кадров в секунду).</p>

<h3 id="что-нельзя-делать-в-главном-основном-потоке">Что нельзя <code class="highlighter-rouge">делать</code> в главном (основном) потоке</h3>

<p>В главном потоке нельзя:</p>

<ul>
  <li>выполнять операции с файлами</li>
  <li>выполнять сетевые запросы</li>
  <li>выполнять операции с базами данных (основа - файлы)</li>
  <li>выполнять любые длительные операции, например: сложные математические расчёты, декодирование графических изображений и т.д.</li>
  <li><code class="highlighter-rouge">явно</code> выполнять вызовы ожидания, например: [Thread.sleep] (https://developer.android.com/reference/java/lang/Thread.html#sleep(long,%20int)) и т.д.</li>
</ul>

<h2 id="что-почитать">Что почитать</h2>

<ul>
  <li>[Keeping your app responsive] (https://developer.android.com/training/articles/perf-anr)</li>
</ul>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
