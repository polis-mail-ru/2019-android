<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>AsyncTask, AsyncTaskLoader | Android курс в Технополисе 2019</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="AsyncTask, AsyncTaskLoader" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/03_async_work/035_asynctask_asyncloader/" />
<meta property="og:url" content="http://localhost:4000/03_async_work/035_asynctask_asyncloader/" />
<meta property="og:site_name" content="Android курс в Технополисе 2019" />
<script type="application/ld+json">
{"url":"http://localhost:4000/03_async_work/035_asynctask_asyncloader/","headline":"AsyncTask, AsyncTaskLoader","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=d3418c91688b3f949df607a428f4549250f0b594">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">Android курс в Технополисе 2019</a></h1>
      

      <p>В этом уроке мы узнаем, что такое Executor, AsyncTask и AsyncTaskLoader.</p>

<h2 id="executor">Executor</h2>

<p><code class="highlighter-rouge">Android SDK</code> включает в себя пакет [java.util.concurrent] (https://developer.android.com/reference/java/util/concurrent/package-summary).
Это один из базовых пакетов, содержащий <code class="highlighter-rouge">примитивы</code>, необходимые для эффективного программирования в конкурентной среде - многопоточном <code class="highlighter-rouge">окружении</code>.</p>

<p>В частности, этот пакет содержит <code class="highlighter-rouge">интерфейс</code> <a href="https://developer.android.com/reference/java/util/concurrent/Executor.html">Executor</a>, на котором базируются классы, поддерживающие выполнение фоновых задач.</p>

<p>Класс <a href="https://developer.android.com/reference/java/util/concurrent/ThreadPoolExecutor.html">ThreadPoolExecutor</a> выполняет задачи, используя (как это видно из названия) пул фоновых потоков. Размер пула может быть разным и, в общем случае, он не ограничен <code class="highlighter-rouge">сверху</code>. Вырожденным случаем является пул, состоящий из одного потока.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="o">...</span>

    <span class="c1">// Создаём ThreadPoolExecutor с пулом из 3 потоков</span>
    <span class="kd">final</span> <span class="n">Executor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>

    <span class="c1">// А вот так делать не надо</span>
    <span class="kd">final</span> <span class="n">Executor</span> <span class="n">nosenseExecutor</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

    <span class="o">...</span>    
</code></pre></div></div>

<p>Загружаем картинку из сети:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="kd">final</span> <span class="n">Executor</span> <span class="n">executor</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>

        <span class="kd">final</span> <span class="n">ImageView</span> <span class="n">imageView</span> <span class="o">=</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">image_view</span><span class="o">);</span>

        <span class="n">executor</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="c1">// Загружаем картинку из сети</span>
            <span class="kd">final</span> <span class="n">Bitmap</span> <span class="n">bitmap</span> <span class="o">=</span> <span class="o">...</span>

            <span class="c1">// Публикуем картинку на главном (UI) потоке, используя для этого</span>
            <span class="c1">// специальный метод, определённый в классе Activity</span>
            <span class="n">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">runOnUiThread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">imageView</span><span class="o">.</span><span class="na">setImageBitmap</span><span class="o">(</span><span class="n">bitmap</span><span class="o">);</span>
            <span class="o">});</span>
        <span class="o">});</span>
    <span class="o">}</span>
    
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Диаграмма последовательности (<code class="highlighter-rouge">sequence diagram</code>) для <code class="highlighter-rouge">ThreadPoolExecutor</code> с пулом, состоящим из одного потока, будет выглядеть следующим образом:</p>

<p><img src="./img/thread_pool_executor_1.png" /></p>

<p>А вот диаграмма последовательности (<code class="highlighter-rouge">sequence diagram</code>) для <code class="highlighter-rouge">ThreadPoolExecutor</code> с пулом, состоящим из трёх потоков:</p>

<p><img src="./img/thread_pool_executor_3.png" /></p>

<p>Понятны основные достоинство класса ThreadPoolExecutor:</p>

<ul>
  <li>==переиспользование уже ‘готовых’ потоков для выполнения задач, вместо создания новых, поскольку создание потока - это достаточно дорогостоящая операция==</li>
  <li>==’одновременное’ выполнение задач, количество которых совпадает с размером пула==</li>
</ul>

<p>==В общем случае, ThreadPoolExecutor не гарантирует порядок выполнения задач.==</p>

<h2 id="asynctask">AsyncTask</h2>

<p>На предыдущих уроках (<a href="/03_async_work/033_handler_queue_looper/">MessageQueue, Looper, Handler</a> и <a href="/03_async_work/034_handler_thread/">HandlerThread</a>) мы познакомились с <code class="highlighter-rouge">базовыми механизмами</code>, которые предлагет <code class="highlighter-rouge">Android SDK</code> для эффективного взаимодействия между потоками. С прикладной точки зрения эти механизмы не очень удобны в использовании, поскольку требуют от разработчика дополнительных усилиий помимо, собственно, решения поставленной задачи.</p>

<p>Для упрощения жизни программиста <code class="highlighter-rouge">Android SDK</code> предлагает использовать высокоуровневый <code class="highlighter-rouge">'интерфейс'</code> взаимодействия между главным (<code class="highlighter-rouge">UI</code>) потоком и фоновым(и) (<code class="highlighter-rouge">worker</code>) потокам(и) - класс <a href="https://developer.android.com/reference/android/os/AsyncTask">AsyncTask</a>.</p>

<p>Класс <code class="highlighter-rouge">AsyncTask</code> инкапсулирует (скрывает) весь механизм взаимодействия между главным (<code class="highlighter-rouge">UI</code>) и фоновым потоками.</p>

<p>От разработчика только требуется <code class="highlighter-rouge">аккупатно наполнить смыслом</code> некоторые методы:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AsyncTask</span><span class="o">&lt;</span><span class="n">Params</span><span class="o">,</span> <span class="n">Progress</span><span class="o">,</span> <span class="n">Result</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="cm">/**
     * Runs on the UI thread before {@link #doInBackground}.
     */</span>
    <span class="nd">@MainThread</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPreExecute</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Override this method to perform a computation on a background thread. The
     * specified parameters are the parameters passed to {@link #execute}
     * by the caller of this task.
     */</span>
    <span class="nd">@WorkerThread</span>
    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="n">Result</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Params</span><span class="o">...</span> <span class="n">params</span><span class="o">);</span>

    <span class="cm">/**
     * &lt;p&gt;Runs on the UI thread after {@link #doInBackground}. The
     * specified result is the value returned by {@link #doInBackground}.&lt;/p&gt;
     * 
     * &lt;p&gt;This method won't be invoked if the task was cancelled.&lt;/p&gt;
     *
     * @param result The result of the operation computed by {@link #doInBackground}.
     */</span>
    <span class="nd">@SuppressWarnings</span><span class="o">({</span><span class="s">"UnusedDeclaration"</span><span class="o">})</span>
    <span class="nd">@MainThread</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">Result</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>Видно, что для выполнения задачи в фоновом потоке нужно переопределить метод <a href="https://developer.android.com/reference/android/os/AsyncTask.html#doInBackground(Params...)">doInBackground(…)</a>. Методы <a href="https://developer.android.com/reference/android/os/AsyncTask.html#onPreExecute()">onPreExecute()</a> и <a href="https://developer.android.com/reference/android/os/AsyncTask.html#onPostExecute(Result)">onPostExecute(…)</a> вызываеются в главном потоке, соответственно, перед и после вызова <code class="highlighter-rouge">doInBackground(...)</code>.</p>

<p>==Необходимо подчеркнуть, что AsyncTask рекомендуется использовать для не продолжительных задач в фоне (порядка нескольких секунд).==</p>

<p>Давайте более подробно рассмотрим <code class="highlighter-rouge">AsyncTask</code> на примерах.</p>

<p>Исходный код примеров демонистрирует использование AsyncTask для выполнения длительных операций в фоновом потоке и доставки результата в главгый (<code class="highlighter-rouge">UI</code>) поток. В качестве примера длительной опреации выполняется скачивание большого файла при помощи <a href="https://developer.android.com/reference/java/net/HttpURLConnection">HttpURLConnection</a>.</p>

<p>Обратите особое внимание на то, как сохраняется и восстанавливается объект <code class="highlighter-rouge">DownloadFileTask</code> при смене конфигурации в <code class="highlighter-rouge">InitSplashActivity</code> - при повороте экрана ранее запущенный таск продолжает выполнение, а результат показывается в новой активности.</p>

<h3 id="пример-1">Пример 1</h3>

<p>Приложение называется <code class="highlighter-rouge">Example 1</code> (<code class="highlighter-rouge">AsyncTaskSampleExample1.zip</code>).</p>

<p>В этом примере скачивание файла происходит в главном (<code class="highlighter-rouge">UI</code>) потоке: в методе <code class="highlighter-rouge">SplashInitActivity.onCreate()</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InitSplashActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"onCreate"</span><span class="o">);</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_init_splash</span><span class="o">);</span>

        <span class="n">titleTextView</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">title_text</span><span class="o">);</span>
        <span class="n">progressBarView</span> <span class="o">=</span> <span class="o">(</span><span class="n">ProgressBar</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">progress_bar</span><span class="o">);</span>

        <span class="n">titleTextView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">downloading</span><span class="o">);</span>
        <span class="n">progressBarView</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">VISIBLE</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// ВНИМАНИЕ: это очень плохая идея -- выполнять сетевые запросы в основном потоке.</span>
            <span class="c1">// Обычно Android просто не дает это сделать -- бросает NetworkOnMainThreadException.</span>
            <span class="c1">// Чтобы продемонстировать, как тормозит UI, мы можем выключить проверку потока, которую</span>
            <span class="c1">// делает система при выполнении сетевых запросов.</span>
            <span class="c1">//</span>
            <span class="c1">// Если закоментировать эту строчку, то можно будет увидеть в логах</span>
            <span class="c1">// NetworkOnMainThreadException.</span>
            <span class="n">StrictMode</span><span class="o">.</span><span class="na">setThreadPolicy</span><span class="o">(</span><span class="k">new</span> <span class="n">StrictMode</span><span class="o">.</span><span class="na">ThreadPolicy</span><span class="o">.</span><span class="na">Builder</span><span class="o">().</span><span class="na">permitAll</span><span class="o">().</span><span class="na">build</span><span class="o">());</span>

            <span class="n">downloadFile</span><span class="o">();</span>
            <span class="n">titleTextView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">done</span><span class="o">);</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Error downloading file: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="n">titleTextView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">error</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">progressBarView</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">INVISIBLE</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>==Это очень плохо!==</p>

<p>Даже потребовалось включить специальный режим <a href="https://developer.android.com/reference/android/os/StrictMode">StrictMode</a> для того, чтобы система в принципе позволила выполнить сетевой запрос (см. комментарий в <code class="highlighter-rouge">SplashInitActivity.onCreate()</code>). Если запустить, то можно увидеть белый экран - приложение <code class="highlighter-rouge">'висит'</code>. Если закомментировать <code class="highlighter-rouge">StrictMode</code>, то приложение завершиться с ошибкой <a href="https://developer.android.com/reference/android/os/NetworkOnMainThreadException.html">NetworkOnMainThreadException</a>.</p>

<h3 id="пример-2">Пример 2</h3>

<p>Приложение называется <code class="highlighter-rouge">Example 2</code> (<code class="highlighter-rouge">AsyncTaskSampleExample2.zip</code>).</p>

<p>В этом примере сделан класс <code class="highlighter-rouge">DownloadFileTask</code>, в котором происходит скачивание файла в фоновом потоке в методе <code class="highlighter-rouge">doInBackground</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/**
     * Таск, выполняющий скачивание файла в фоновом потоке.
     */</span>
    <span class="kd">class</span> <span class="nc">DownloadFileTask</span> <span class="kd">extends</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>

        <span class="cm">/**
         * Скачивание файла в фоновом потоке. Возвращает результат:
         *      0 -- если файл успешно скачался
         *      1 -- если произошла ошибка
         */</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">Integer</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Void</span><span class="o">...</span> <span class="n">ignore</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">downloadFile</span><span class="o">();</span>
                <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>

            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"Error downloading file: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="o">...</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>==Во время скачивания показывается индикатор типа Indeterminate (крутилка) при помощи ProgressBarView. Таск всегда просто запускается в методе onCreate, поэтому при каждом повороте экрана скачивание запускается снова (осторожно, трафик!).==</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InitSplashActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"onCreate"</span><span class="o">);</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_init_splash</span><span class="o">);</span>

        <span class="n">titleTextView</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">title_text</span><span class="o">);</span>
        <span class="n">progressBarView</span> <span class="o">=</span> <span class="o">(</span><span class="n">ProgressBar</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">progress_bar</span><span class="o">);</span>

        <span class="n">titleTextView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">downloading</span><span class="o">);</span>
        <span class="n">progressBarView</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">VISIBLE</span><span class="o">);</span>

        <span class="k">new</span> <span class="nf">DownloadFileTask</span><span class="o">().</span><span class="na">execute</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="пример-3">Пример 3</h3>

<p>Приложение называется <code class="highlighter-rouge">Example 3</code> (<code class="highlighter-rouge">AsyncTaskSampleExample3.zip</code>).</p>

<p>Индикатор типа <code class="highlighter-rouge">Indeterminate</code> заменен на индикатор прогресса - этот тот же <code class="highlighter-rouge">ProgressBarView</code>, но с другим стилем. Используются методы <a href="https://developer.android.com/reference/android/os/AsyncTask.html#publishProgress(Progress...)">AsyncTask.publishProgress</a> и <a href="https://developer.android.com/reference/android/os/AsyncTask.html#onProgressUpdate(Progress...)">AsyncTask.onProgressUpdate</a> для отображения прогресса загрузки.</p>

<p>По-прежнему запускается новый таск при каждой смене конфигурации (повороте экрана) – в логах можно увидеть, как после поворота экрана продолжается выполнение старого таска загрузки, и только после завершения старой загрузки стартует новая загрузка. В интерфейсе это заметно по тому, как останавливаетя прогресс после поворота экрана (в это время выполняется старый таск, но он не связан с новым экраном и не обновляет прогресс), а спустя некоторое время он сбрасывается в начало (это начинает работать новый таск, связанный с текущим экраном).</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InitSplashActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"onCreate"</span><span class="o">);</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_init_splash</span><span class="o">);</span>

        <span class="n">titleTextView</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">title_text</span><span class="o">);</span>
        <span class="n">progressBarView</span> <span class="o">=</span> <span class="o">(</span><span class="n">ProgressBar</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">progress_bar</span><span class="o">);</span>

        <span class="n">titleTextView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">downloading</span><span class="o">);</span>

        <span class="n">progressBarView</span><span class="o">.</span><span class="na">setProgress</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">progressBarView</span><span class="o">.</span><span class="na">setMax</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
        <span class="n">progressBarView</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">VISIBLE</span><span class="o">);</span>

        <span class="k">new</span> <span class="nf">DownloadFileTask</span><span class="o">().</span><span class="na">execute</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="пример-4">Пример 4</h3>

<p>Приложение называется <code class="highlighter-rouge">Example 4</code> (<code class="highlighter-rouge">AsyncTaskSampleExample4.zip</code> и <code class="highlighter-rouge">AsyncTaskSampleMaster.zip</code>).</p>

<p>Это финальный пример. Устранены описанные выше недостатки.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InitSplashActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="nd">@Override</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"deprecation"</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">"onCreate"</span><span class="o">);</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_init_splash</span><span class="o">);</span>

        <span class="n">titleTextView</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">title_text</span><span class="o">);</span>
        <span class="n">progressBarView</span> <span class="o">=</span> <span class="o">(</span><span class="n">ProgressBar</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">progress_bar</span><span class="o">);</span>

        <span class="n">progressBarView</span><span class="o">.</span><span class="na">setMax</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">savedInstanceState</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Пытаемся получить ранее запущенный таск</span>
            <span class="n">downloadTask</span> <span class="o">=</span> <span class="o">(</span><span class="n">DownloadFileTask</span><span class="o">)</span> <span class="n">getLastNonConfigurationInstance</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">downloadTask</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Создаем новый таск, только если не было ранее запущенного таска</span>
            <span class="n">downloadTask</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DownloadFileTask</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="n">downloadTask</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// Передаем в ранее запущенный таск текущий объект Activity</span>
            <span class="n">downloadTask</span><span class="o">.</span><span class="na">attachActivity</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="замечания">Замечания</h3>

<ul>
  <li>в упрощённом виде диаграмма последовательности (<code class="highlighter-rouge">sequence diagram</code>) для <code class="highlighter-rouge">AsyncTask</code> выгдядит следующим образом:</li>
</ul>

<p><img src="./img/async_task_sequence_diagram.png" /></p>

<ul>
  <li>в общем случае корректная диаграмма последовательности (<code class="highlighter-rouge">sequence diagram</code>) для <code class="highlighter-rouge">AsyncTask</code> выгдядит следующим образом:</li>
</ul>

<p><img src="./img/async_task_sequence_diagram2.png" /></p>

<ul>
  <li>
    <p>==имеет место быть проблема жизненного цикла для класса AsyncTask при не корректной реализации (см. предыдущую диаграмму)==</p>
  </li>
  <li>
    <p>по умолчанию, <code class="highlighter-rouge">AsyncTask</code>, использует один фоновый поток для выполнения задач.</p>
  </li>
</ul>

<h3 id="домашнее-задание">Домашнее задание</h3>

<p><a href="https://github.com/grialnick/homework">Написать приложение City Cam, которое предлагает пользователю выбрать город из списка и показывает статичное изображение с веб-камеры в выбранном городе</a></p>

<h2 id="asynctaskloader-loader">AsyncTaskLoader (Loader)</h2>

<p>Класс <a href="https://developer.android.com/reference/android/content/AsyncTaskLoader">AsyncTaskLoader</a> решает проблему загрузки данных в фоновом потоке и публикацию результатов в главном (<code class="highlighter-rouge">UI</code>) потоке процесса.</p>

<p>По сути, <code class="highlighter-rouge">AsyncTaskLoader</code> предназначен для решения тех же задач, что и рассмотренный нами выше <code class="highlighter-rouge">AsyncTask</code>.</p>

<p>Необходимо выделить:</p>

<ul>
  <li>==в классе AsyncTaskLoader решена проблема жизненного цикла (см. выше)==</li>
  <li>проще в использовании, чем <code class="highlighter-rouge">AsyncTask</code></li>
  <li>по умолчанию, <code class="highlighter-rouge">AsyncTaskLoader</code>, выполняет задачи <code class="highlighter-rouge">на пуле потоков</code>, т.е. может выполняться несколько задач параллельно</li>
  <li>отсутствие хорошей документации</li>
  <li>также рекомендуется использовать для не продолжительных задач в фоне</li>
</ul>

<h2 id="что-почитать">Что почитать</h2>

<ul>
  <li>[Concurrency] (https://docs.oracle.com/javase/tutorial/essential/concurrency/index.html)</li>
  <li>[Классика: Java Concurrency In Practice] (https://www.ozon.ru/context/detail/id/3174887)</li>
</ul>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
