<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Unit тесты | Android курс в Технополисе 2019</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="Unit тесты" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/10_testing_CI/102_unit_tests/" />
<meta property="og:url" content="http://localhost:4000/10_testing_CI/102_unit_tests/" />
<meta property="og:site_name" content="Android курс в Технополисе 2019" />
<script type="application/ld+json">
{"url":"http://localhost:4000/10_testing_CI/102_unit_tests/","headline":"Unit тесты","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=d3418c91688b3f949df607a428f4549250f0b594">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">Android курс в Технополисе 2019</a></h1>
      

      <p>Сначала немного скучной теории:</p>

<h2 id="когда-можно-применять">Когда можно применять.</h2>
<ol>
  <li>Когда нужно эмулировать сложные ошибки, использовать знание о коде для того чтобы проверить 
все ветвления приложения и различные состояние объектов которые крайне тяжело эмулировать в e2e тестировании.</li>
  <li>Когда приложение еще не готово. При написании Unit тестов нет необходимости дожидаться готовности кода всего приложения
или даже отдельного компонента, можно писать тесты только для одного метода.</li>
  <li>Когда надо быстро находить ошибки. 
Если ошибка существует, то для ее обнаружения и устранения как правило понадобится меньше времени, чем при дебаггинге приложения.</li>
  <li>Когда добавление очередного Unit теста вызывает затруднение, либо Unit тест получается громоздким и запутанным.
Также, если нет возможности проверить метод в изоляции, вероятнее всего код имеет высокую связность (high coupling)</li>
  <li>Когда надо вспомнить как работает метод.
Unit тесты являются своеобразной «документацией в примерах» для кода проекта.</li>
</ol>

<h2 id="первый-junit-тест">Первый JUnit тест</h2>
<p>Unit-тесты в андроиде по умолчанию хранятся в <strong>src/test/java</strong>. 
<img src="img/where_units_live.png" width="1200px" />
Другое место хранения можно настроить в секции <code class="highlighter-rouge">sourceSets</code> в gradle файле приложения.</p>
<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">android</span> <span class="o">{</span>
    <span class="n">sourceSets</span> <span class="o">{</span>
        <span class="n">test</span> <span class="o">{</span>
            <span class="n">java</span><span class="o">.</span><span class="na">srcDirs</span> <span class="o">=</span> <span class="o">[</span><span class="s1">'src/test/java'</span><span class="o">,</span>
                            <span class="s1">'src/test_utils/java'</span><span class="o">]</span>
            <span class="n">resources</span><span class="o">.</span><span class="na">srcDirs</span> <span class="o">=</span> <span class="o">[</span><span class="s1">'src/test/resources'</span><span class="o">]</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>
<p><img src="img/change_source_sets.png" width="1200px" />
На рисунке видно, что мы добавили еще папку <code class="highlighter-rouge">test_utils</code>. Она тоже будет использоваться при выполнения тестов. Там
будут лежать утилиты.
Также на рисунке видно, что для тестовой конфигурации используется конструкция <strong>testImplementation</strong>. Если какая-то билблиотека
нужна для Unit-тестов, то подключаем ее или в <strong>testImplementation</strong> или в <strong>testApi</strong>.</p>

<p>В приложении <strong>Testing example</strong> есть класс <code class="highlighter-rouge">Calculator</code>, который выполняет вычисления:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Calculator</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">result</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">firstDigit</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">secondDigit</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">error</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Calculator</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Calculator</span><span class="o">();</span>

    <span class="kd">private</span> <span class="nf">Calculator</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">firstDigit</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">secondDigit</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Calculator</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Calculator</span> <span class="nf">add</span><span class="o">(</span><span class="n">Integer</span> <span class="n">first</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">second</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        <span class="n">firstDigit</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
        <span class="n">secondDigit</span> <span class="o">=</span> <span class="n">second</span><span class="o">;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">firstDigit</span> <span class="o">+</span> <span class="n">secondDigit</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Calculator</span> <span class="nf">subtract</span><span class="o">(</span><span class="n">Integer</span> <span class="n">first</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">second</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        <span class="n">firstDigit</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
        <span class="n">secondDigit</span> <span class="o">=</span> <span class="n">second</span><span class="o">;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">firstDigit</span> <span class="o">-</span> <span class="n">secondDigit</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Calculator</span> <span class="nf">multiply</span><span class="o">(</span><span class="n">Integer</span> <span class="n">first</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">second</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        <span class="n">firstDigit</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
        <span class="n">secondDigit</span> <span class="o">=</span> <span class="n">second</span><span class="o">;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">firstDigit</span> <span class="o">*</span> <span class="n">secondDigit</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Calculator</span> <span class="nf">divide</span><span class="o">(</span><span class="n">Integer</span> <span class="n">first</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">second</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        <span class="n">firstDigit</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
        <span class="n">secondDigit</span> <span class="o">=</span> <span class="n">second</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">secondDigit</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s">"На ноль делить нельзя"</span><span class="o">;</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">firstDigit</span> <span class="o">/</span> <span class="n">secondDigit</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>Это чистый Java код. В нем нет ничего от Android. А значит мы можем создать Unit тест, который будет для нас тестировать этот класс.
Самый простой способ создать Unit-тест. Это кликнуть правой кнопкой в теле класса и выбрать <strong>Go To</strong>.
<img src="img/test_creation.png" width="1200px" />
Дальше можно выбрать куда добавить новый тест. Это может быть как новый класс, так и существующий.</p>

<p><img src="img/create_new_test.png" width="1200px" /></p>

<p>Дальше будет “мастер”, в котором можно выбрать:</p>
<ul>
  <li>тип теста. Мы сейчас говорим о JUnit4, который является стандартом.</li>
  <li>Название класса с тестами. По умолчанию к классу добавляется суффикс Test.</li>
  <li>Класс родитель, если есть.</li>
  <li>package. Важная вещь. Если тестовый класс находится в таком же пакете как и класс приложения, то мы будем иметь доступ
к его <strong>protected</strong> и  <strong>package-private</strong> методам. В противном случае, мы сможем обращаться только к <strong>public</strong> методам. Без ухищрений.</li>
  <li>Дальше можно выбрать создавать ли нам фикстуры для настройки состояния тестов.</li>
  <li>Можно выбрать методы для которых писать тесты.</li>
</ul>

<p><img src="img/test_creation_master.png" width="1200px" /></p>

<p>Я создам один тест в классе <code class="highlighter-rouge">SimpleCalculatorTest</code>
`</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="n">JUnit4</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleCalculatorTest</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Calculator</span> <span class="n">calculator</span><span class="o">;</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">Calculator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">additionTest</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">calculator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span>
        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="n">calculator</span><span class="o">.</span><span class="na">getResult</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>Аннотация <code class="highlighter-rouge">@RunWith</code> показывает какой раннер будет использован для запуска тестов. В простейшем случае, когда используются
только Junit4 тесты, эту аннотацию можно опустить. Раннер должен знать как ему искать тесты. Для JUnit4, раннер будет искать все
методы внутри класса, которые помечены аннотацией <code class="highlighter-rouge">@Test</code>.</li>
  <li>Нужен public класс, который выступит хранилищем тестов <code class="highlighter-rouge">SimpleCalculatorTest</code>.</li>
  <li>Это аннотация для обозначния фикстуры (о них ниже).</li>
  <li>Сам тест.</li>
</ol>

<p>Сначала создаем экземпляр класса Calculator. На нем будем проводить тест
Складываем два числа 2 и 3, они запишутся в поле result внутри класса Calculator.
Методом assertEquals сравниваем ожидаемый результат и то, что вернет нам Сalculator. 
Если значения окажутся не равны, то при запуске теста метод assertEquals выбросит ошибку.</p>

<h2 id="фикстуры">Фикстуры</h2>
<p>Фикстуры - фиксированные состояния объектов используемые в качестве исходных данных при запуске тестов.
Фикстуры позволяют многократно использовать один и тот же исходный код, в случае, если исходные данные для нескольких тестов одинаковые.</p>
<ol>
  <li>Аннотация <code class="highlighter-rouge">@Before</code> обозначает методы, которые будут вызваны до исполнения теста, методы должны быть public void. 
Здесь обычно размещаются предустановки для теста, в нашем случае это получение инстанса Calculator.</li>
  <li>Аннотация <code class="highlighter-rouge">@BeforeClass</code> обозначает методы, которые будут вызваны до создания экземпляра тест-класса,
методы должны быть public static void. Это однократная</li>
  <li>Аннотация <code class="highlighter-rouge">@After</code> обозначает методы, которые будут вызваны после выполнения теста, методы должны быть public void. 
Здесь размещаются операции освобождения ресурсов после теста, .</li>
  <li>Аннотация <code class="highlighter-rouge">@AfterClass</code> связана по смыслу с @BeforeClass, выполняется один раз после прогона всех тестов.</li>
</ol>

<p>В классе <code class="highlighter-rouge">FixturesExampleWithRule</code> есть следующий код:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Rule</span>
        <span class="kd">public</span> <span class="n">TestName</span> <span class="n">name</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TestName</span><span class="o">();</span>
    
        <span class="nd">@BeforeClass</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setupClass</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"BeforeClass SimpleCalculatorTestWithRule started"</span><span class="o">);</span>
        <span class="o">}</span>
    
        <span class="nd">@Before</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Test name %s started"</span><span class="o">,</span> <span class="n">name</span><span class="o">.</span><span class="na">getMethodName</span><span class="o">()));</span>
            <span class="n">calculator</span> <span class="o">=</span> <span class="n">Calculator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
        <span class="o">}</span>
    
        <span class="nd">@Test</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">multiplicationTest</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">calculator</span><span class="o">.</span><span class="na">multiply</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span>
            <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="n">calculator</span><span class="o">.</span><span class="na">getResult</span><span class="o">());</span>
        <span class="o">}</span>
    
        <span class="nd">@Test</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">divisionTest</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">calculator</span><span class="o">.</span><span class="na">divide</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span>
            <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">calculator</span><span class="o">.</span><span class="na">getResult</span><span class="o">());</span>
        <span class="o">}</span>
    
        <span class="nd">@After</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">tearDown</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Test name %s finished"</span><span class="o">,</span> <span class="n">name</span><span class="o">.</span><span class="na">getMethodName</span><span class="o">()));</span>
        <span class="o">}</span>
    
        <span class="nd">@AfterClass</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">tearDownClass</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"BeforeClass SimpleCalculatorTestWithRule finished"</span><span class="o">);</span>
        <span class="o">}</span>
</code></pre></div></div>
<p>Здесь два теста и 4 фикстуры. После запуска класса в консоль выведется следующее:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BeforeClass FixturesExampleWithRule started

    Test name divideTest started
    Test name divideTest finished

    Test name multiplicationTest started
    Test name multiplicationTest finished

BeforeClass FixturesExampleWithRule finished
</code></pre></div></div>

<h2 id="правила">Правила</h2>
<p>Кроме всего вышеперечисленного есть довольно интересная вещь — правила. 
Правила это некое подобие утилит для тестов, которые добавляют функционал до и после выполнения теста.</p>

<p>Например, есть встроенные правила для задания таймаута для теста(Timeout), для задания ожидаемых исключений(ExpectedException), для работы с временными файлами(TemporaryFolder) и д.р. 
Для объявления правила необходимо создать public не static поле типа производного от MethodRule и зааннотировать его с помощью Rule.
Пример в <code class="highlighter-rouge">RulesExample</code> классе.</p>

<p>Правила выполняются после <code class="highlighter-rouge">@Before</code> и после <code class="highlighter-rouge">@BeforeClass</code></p>

<h2 id="дополнительные-аннотации-для-тестов">Дополнительные аннотации для тестов</h2>
<p>Можно извлечь дополнительную функциональность из аннотации <code class="highlighter-rouge">@Test</code></p>
<ul>
  <li>Тест будет работать не больше секунды, а потом упадет
<code class="highlighter-rouge">@Test(timeout = 1000)</code>  <br />
*Аннотация для перехвата исключения
 <code class="highlighter-rouge">@Test(expected = IllegalStateException.class)</code>      <br />
*Тест не будет выполняться
<code class="highlighter-rouge">@Ignore("Разберусь потом")</code>
Пример в <code class="highlighter-rouge">TestAnnotationParameters</code> классе.</li>
</ul>

<p>##Утверждения
В каждом тесте должно быть хотя бы одоно утверждение (assert).
Они необходимы иначе тест будет постоянно проходить и будет бесполезен.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">condition</span><span class="o">)</span>
<span class="n">Assert</span><span class="o">.</span><span class="na">assertFalse</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">condition</span><span class="o">)</span>
<span class="n">AssertNull</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">)</span>
<span class="n">Assert</span><span class="o">.</span><span class="na">Equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">expected</span><span class="o">,</span> <span class="n">Object</span> <span class="n">actual</span><span class="o">)</span>
<span class="o">...</span>
</code></pre></div></div>

<p>Пройдемся по параметрам:</p>
<ul>
  <li><code class="highlighter-rouge">message</code> - это сообщение, которые будет выброшено при наступлении ошибки. Лучше написать его наиболее понятным, чтобы
быстрее разобраться в корне проблемы.</li>
  <li><code class="highlighter-rouge">condition</code> - это условие, которое должно вернуть <code class="highlighter-rouge">boolean</code>. Возьмем пример с вычитанием.
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="o">;</span>
<span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="s">"Результат 1 - 2 должен быть меньше нуля"</span><span class="o">,</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">);</span>
</code></pre></div>    </div>
  </li>
  <li><code class="highlighter-rouge">expected</code> - это эталонное значение, с которым сравниваем (опираемся на него).</li>
  <li><code class="highlighter-rouge">actual</code> - это значение, которое получили во время теста.
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="o">;</span>
<span class="c1">//Если сообщения будут не равны, Junit напишет значения expected и actual, поэтому в большинстве случаев, </span>
<span class="c1">//сообщение можно опустить.</span>
<span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>Гугл рекомендует юзать свою либу для ассершена <a href="http://google.github.io/truth/">Туториал к Google Truth</a>.
Также есть библиотека <a href="http://hamcrest.org/JavaHamcrest/tutorial">Туториал к hamcrest либе</a>, в которой много много дополнительных матчеров.
Она намного чаще используется в паре с JUnit’ом.</p>

<h2 id="как-запускать-тесты">Как запускать тесты</h2>
<p>Запускать можно с помощью кнопки <strong>play</strong>. В меню можно выбрать нужный метод запуска.
<img src="img/launch_test.png" width="1200px" />
С помощью кнопки плэй можно запустить как один тест в классе так и все тесты внутри класса.
Также тесты можно запустить с помощью <strong>gradle</strong>.
Так запустятся все тесты во всех модулях.</p>
<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">./</span><span class="n">gradlew</span> <span class="n">test</span>
</code></pre></div></div>
<p>Можно добавить фильтрации с помощью ключа <code class="highlighter-rouge">--tests</code></p>
<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//выполнить все тесты в SimpleCalculatorTest классе</span>
<span class="o">./</span><span class="n">gradlew</span> <span class="nl">app:</span><span class="n">testDebugUnitTest</span> <span class="o">--</span><span class="n">tests</span> <span class="n">SimpleCalculatorTest</span>

<span class="c1">//выполнить один тест в SimpleCalculatorTest</span>
<span class="o">./</span><span class="n">gradlew</span> <span class="n">test</span> <span class="o">--</span><span class="n">tests</span> <span class="n">SimpleCalculatorTest</span><span class="o">.</span><span class="na">additionTest</span>

<span class="c1">//выполнить тесты по маске внутри класса</span>
<span class="o">./</span><span class="n">gradlew</span> <span class="n">test</span>  <span class="o">--</span><span class="n">tests</span> <span class="n">SimpleCalculatorTest</span><span class="o">.*</span><span class="n">addition</span><span class="o">*</span>

<span class="c1">//указание класса через fqn</span>
<span class="o">./</span><span class="n">gradlew</span> <span class="nl">app:</span><span class="n">testDebugUnitTest</span>  <span class="o">--</span><span class="n">tests</span> <span class="n">ru</span><span class="o">.</span><span class="na">android2019</span><span class="o">.</span><span class="na">testingexample</span><span class="o">.</span><span class="na">SimpleCalculatorTest</span>

<span class="c1">//указание класса и метода через fqn</span>
<span class="o">./</span><span class="n">gradlew</span> <span class="nl">app:</span><span class="n">testDebugUnitTest</span>  <span class="o">--</span><span class="n">tests</span> <span class="n">ru</span><span class="o">.</span><span class="na">android2019</span><span class="o">.</span><span class="na">testingexample</span><span class="o">.</span><span class="na">SimpleCalculatorTest</span><span class="o">.</span><span class="na">additionTest</span>

<span class="c1">//все тесты внутри пакета (рекурсивно)</span>
<span class="o">./</span><span class="n">gradlew</span> <span class="nl">app:</span><span class="n">testDebugUnitTest</span> <span class="o">--</span><span class="n">tests</span> <span class="n">ru</span><span class="o">.</span><span class="na">android2019</span><span class="o">.</span><span class="na">testingexample</span><span class="o">.*</span>

</code></pre></div></div>

<h2 id="моки-и-стабы">Моки и стабы</h2>
<p>Не всегда есть возможность создать все объекты для теста функции:</p>
<ol>
  <li>Иногда это слишком сложно из-за большой вложенности параметров и объектов.</li>
  <li>Иногда нужного класса еще нет или он может поменять поведение.</li>
  <li>Иногда объект производит неопределенные результаты (например текущее время)
Для того чтобы справиться с этими ситуациями были придуманы Моки (объекты заглушки, тестовые дубли)
Такой объект иммитирует поведение объекта или может добавлять дополнительную информацию к нему (Spy)</li>
</ol>

<p>Немного скучной теории:
<img src="img/test_double.png" width="1200px" /></p>
<ol>
  <li>Dummy object - когда реализация объекта совсем не важна, ее даже можно заменить на <code class="highlighter-rouge">null</code>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addCustomerWithDummyTest</span><span class="o">()</span> <span class="o">{</span>
 <span class="c1">//dummy не имеет никакого переопределенного поведения</span>
 <span class="n">Customer</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
 <span class="n">AddressBook</span> <span class="n">addressBook</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AddressBook</span><span class="o">();</span>
 <span class="n">addressBook</span><span class="o">.</span><span class="na">addCustomer</span><span class="o">(</span><span class="n">dummy</span><span class="o">);</span>
 <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">addressBook</span><span class="o">.</span><span class="na">getNumberOfCustomers</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>Test Stub - Когда мы возвращаем фиксированные значения для методов объектов.
В примере ниже это значение для размера списка
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">when</span><span class="o">(</span><span class="n">mockedList</span><span class="o">.</span><span class="na">size</span><span class="o">()).</span><span class="na">thenReturn</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
</code></pre></div>    </div>
  </li>
  <li>Mock Object - объекты которые позволяют контролировать поведение объектов во время тестов.
В терминах Mockito - это может быть конструкция
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">verify</span><span class="o">(</span><span class="n">stringListMock</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="s">"somestring"</span><span class="o">);</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Test Spy - реальный объект, чьи методы можно переопределить.</p>
  </li>
  <li>Fake Object - специальный объект, который может выглядеть как реальный, но сконструирован только для 
теста. В полях может быть билиберда сгенирированная</li>
</ol>

<p>Самая популярная библиотека для создания Моков - это <a href="https://site.mockito.org/">Mockito</a>
Для ее работы надо добавить ее в <code class="highlighter-rouge">build.gradle</code></p>
<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">testCompile</span> <span class="s1">'org.mockito:mockito-core:2.8.0'</span>
</code></pre></div></div>
<p>В тестах, в классе  <code class="highlighter-rouge">ru.android2019.testingexample.emailValidator.SharedPreferencesHelperTest</code> будем использовать Mockito
чтобы создать заглушку для <code class="highlighter-rouge">SharedPreferences</code>. Т.к. <code class="highlighter-rouge">SharedPreferences</code> это часть Android API мы не сможем протестировать
ее в локально JVM, поэтому мы сделаем объект, который будет повторять нужное нам поведение и выдавать себя за <code class="highlighter-rouge">SharedPreferences</code>.</p>

<p>Мокированный объект можно создать двумя способами:</p>

<ol>
  <li>Вызвать статический метод <code class="highlighter-rouge">mock</code> на прямую. Создастся пустой объект, который не умеет ничего делать.
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SharedPreferences</span><span class="o">.</span><span class="na">Editor</span> <span class="n">mMockEditor</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">SharedPreferences</span><span class="o">.</span><span class="na">Editor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div>    </div>
  </li>
  <li>С помощью аннотации <code class="highlighter-rouge">@Mock</code>. Для ее правильной работы надо обязательно инициировать ее
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nd">@Mock</span>
 <span class="n">SharedPreferences</span> <span class="n">mMockSharedPreferences</span><span class="o">;</span>
    
 <span class="nd">@Before</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initMocks</span><span class="o">()</span> <span class="o">{</span>
     <span class="c1">//инициализация аннотаций</span>
     <span class="n">MockitoAnnotations</span><span class="o">.</span><span class="na">initMocks</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>Далее нам надо настроить объект заглушку
Для этого используется конструкция  <code class="highlighter-rouge">when</code> … <code class="highlighter-rouge">thenReturn</code>
В примере ниже при запросе настройки по <code class="highlighter-rouge">KEY_NAME="key_name"</code> нам будет возвращаться <code class="highlighter-rouge">TEST_NAME = "Test name"</code>
Т.е. если где-то в тесте мы вызовем ` mSharedPreferences.getString(KEY_NAME, “”);<code class="highlighter-rouge"> нам вернется </code>“Test name”<code class="highlighter-rouge">
Полную настройку можно посмотреть с </code>emailValidator.SharedPreferencesHelperTest#createMockSharedPreference`
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">when</span><span class="o">(</span><span class="n">mMockSharedPreferences</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">eq</span><span class="o">(</span><span class="n">SharedPreferencesHelper</span><span class="o">.</span><span class="na">KEY_NAME</span><span class="o">),</span> <span class="n">anyString</span><span class="o">()))</span>
             <span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">mSharedPreferenceEntry</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="методы-mockito">Методы Mockito</h2>
<p>Другие методы, которые предоставляет Mockito мы посмотрим немного в отрыве от Android</p>
<ol>
  <li><code class="highlighter-rouge">@Spy</code> - эта аннотация создает обертку вокруг реального объекта. Т.е. в отличие от <code class="highlighter-rouge">@Mock</code> у нас получится не пустая 
заглушка, а полноценный <code class="highlighter-rouge">ArrayList&lt;String&gt;</code> со всеми методами, но мы также можем переопределять нужные нам методы.
В примере ниже был переопределен метод <code class="highlighter-rouge">size()</code>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nd">@Spy</span>
 <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">spiedList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>

 <span class="nd">@Before</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initMocks</span><span class="o">()</span> <span class="o">{</span>
     <span class="n">MockitoAnnotations</span><span class="o">.</span><span class="na">initMocks</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
 <span class="o">}</span>

 <span class="nd">@Test</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">spyAnnotation</span><span class="o">()</span> <span class="o">{</span>
     <span class="c1">//Добавляем сторочки в лист. Он должен вести себя также как обычный ArrayList.</span>
     <span class="n">spiedList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"one"</span><span class="o">);</span>
     <span class="n">spiedList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"one"</span><span class="o">);</span>
     <span class="n">spiedList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"two"</span><span class="o">);</span>

     <span class="c1">//Проверяем, что метод add("one") вызывался два раза</span>
     <span class="n">verify</span><span class="o">(</span><span class="n">spiedList</span><span class="o">,</span><span class="n">times</span><span class="o">(</span><span class="mi">2</span><span class="o">)).</span><span class="na">add</span><span class="o">(</span><span class="s">"one"</span><span class="o">);</span>
     <span class="n">verify</span><span class="o">(</span><span class="n">spiedList</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="s">"two"</span><span class="o">);</span>

     <span class="n">assertEquals</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">spiedList</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>

     <span class="c1">//Переопределяем метод size() для ArrayList</span>
     <span class="n">Mockito</span><span class="o">.</span><span class="na">doReturn</span><span class="o">(</span><span class="mi">100</span><span class="o">).</span><span class="na">when</span><span class="o">(</span><span class="n">spiedList</span><span class="o">).</span><span class="na">size</span><span class="o">();</span>
     <span class="n">assertEquals</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="n">spiedList</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li><code class="highlighter-rouge">@Captor</code> - аннотация для <code class="highlighter-rouge">ArgumentCaptor</code> позволяет перехватывать переданные аргументы в функцию и сравнивать их в ассертах.
Следующий пример слишком простой, но если бы на месте строки был сложный объект, это было бы полезно.
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Mock</span>
 <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">mockedList</span><span class="o">;</span>

 <span class="c1">//с помощью каптора можем проверять значения аргументов.</span>
 <span class="nd">@Captor</span>
 <span class="n">ArgumentCaptor</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">argCaptor</span><span class="o">;</span>

 <span class="nd">@Before</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initMocks</span><span class="o">()</span> <span class="o">{</span>
     <span class="c1">//Необходимая инициализация</span>
     <span class="n">MockitoAnnotations</span><span class="o">.</span><span class="na">initMocks</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

 <span class="o">}</span>

 <span class="nd">@Test</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">whenUseCaptorAnnotation_thenTheSam</span><span class="o">()</span> <span class="o">{</span>
     <span class="n">mockedList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"one"</span><span class="o">);</span>
     <span class="n">Mockito</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">mockedList</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="n">argCaptor</span><span class="o">.</span><span class="na">capture</span><span class="o">());</span>

     <span class="n">assertEquals</span><span class="o">(</span><span class="s">"one"</span><span class="o">,</span> <span class="n">argCaptor</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li><code class="highlighter-rouge">@InjectMocks</code> - позволяет подставлять уже мокированные объекты в  объект с этой аннотацией.
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nd">@Mock</span>
 <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">wordMap</span><span class="o">;</span>
    
 <span class="c1">//автоматически подставляем wordMap в MyDictionary</span>
 <span class="nd">@InjectMocks</span>
 <span class="n">MyDictionary</span> <span class="n">dic</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyDictionary</span><span class="o">();</span>

 <span class="nd">@Before</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initMocks</span><span class="o">()</span> <span class="o">{</span>
     <span class="c1">//Необходимая инициализация</span>
     <span class="n">MockitoAnnotations</span><span class="o">.</span><span class="na">initMocks</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
 <span class="o">}</span>

 <span class="nd">@Test</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">whenUseInjectMocksAnnotation_thenCorrect</span><span class="o">()</span> <span class="o">{</span>
     <span class="n">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">wordMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"aWord"</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="s">"aMeaning"</span><span class="o">);</span>

     <span class="n">assertEquals</span><span class="o">(</span><span class="s">"aMeaning"</span><span class="o">,</span> <span class="n">dic</span><span class="o">.</span><span class="na">getMeaning</span><span class="o">(</span><span class="s">"aWord"</span><span class="o">));</span>
 <span class="o">}</span>

 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyDictionary</span> <span class="o">{</span>
     <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">wordMap</span><span class="o">;</span>

     <span class="kd">public</span> <span class="nf">MyDictionary</span><span class="o">()</span> <span class="o">{</span>
         <span class="n">wordMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
     <span class="o">}</span>

     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">word</span><span class="o">,</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">meaning</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">wordMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">word</span><span class="o">,</span> <span class="n">meaning</span><span class="o">);</span>
     <span class="o">}</span>

     <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMeaning</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">word</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">wordMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>
     <span class="o">}</span>
 <span class="o">}</span>
</code></pre></div>    </div>
    <h2 id="powermock">PowerMock</h2>
  </li>
</ol>

<p>Мокито не умеет делать стабы на статические или приватные методы (в последних версиях это добавили, но фича позиционируется,
как incubating).
Для этого используется библиотека <a href="https://github.com/powermock/powermock/wiki/Getting-Started">PowerMock</a>
она поставляется как расширение для Mockito. На данный момент Mockito 2 поддерживается в экспериментальном режиме и 
иногда приходтся помучаться с зависимостями. Зато с помощью PowerMock можно протестировать практически любой код, даже
который не спроектирован для тестирования.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="n">PowerMockRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@PrepareForTest</span><span class="o">(</span><span class="n">EmailValidator</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PowerMockTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">powerMockTest</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">PowerMockito</span><span class="o">.</span><span class="na">mockStatic</span><span class="o">(</span><span class="n">EmailValidator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">//смогли замокать статический метод</span>
        <span class="n">PowerMockito</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">EmailValidator</span><span class="o">.</span><span class="na">isValidEmail</span><span class="o">(</span><span class="n">anyString</span><span class="o">())).</span><span class="na">thenReturn</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">assertTrue</span><span class="o">(</span><span class="n">EmailValidator</span><span class="o">.</span><span class="na">isValidEmail</span><span class="o">(</span><span class="s">"not real email"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>Пример можно посмотреть здесь <code class="highlighter-rouge">ru.android2019.testingexample.powerMockExample.PowerMockTest</code></p>

<h2 id="robolectric">Robolectric</h2>
<p>При использовании не замоканного кода Android фреймворка, можно получить исключение.
RuntimeException c причиной — method not mocked при попытке запустить тест кода вызывающего какой — либо метод фреймворка.</p>

<p>Если использовать следующую опцию в Gradle</p>
<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">testOptions</span> <span class="o">{</span>
    <span class="n">unitTests</span><span class="o">.</span><span class="na">returnDefaultValues</span> <span class="o">=</span> <span class="kc">true</span>
<span class="o">}</span>
</code></pre></div></div>
<p>то, RuntimeException брошен не будет. Такое поведение может приводить к тяжело детектируемым ошибкам в тестах.</p>

<p>На помощь приходит Robolectric -  это специальная опен-сорсная библиотека, которая состоит из специально скомпилированного <code class="highlighter-rouge">android.jar</code>
с обвязкой из утилит для запуска тестов и упрощения тестирования. Он поддерживает загрузку ресурсов, 
примитивную реализацию инфлэйта View (не поддерживает CustomView), предоставляет локальную SQLite (sqlite4java), 
легко кастомизируем и расширяем. Тесты с использованием Robolectric уже относятся к интеграционным, они стоят между
Unit-тестами и Instrumentation тестами. Хранятся они вместе с Unit-тестами, т.к. выполняются на локальной JVM.
либо других ресурсов приложения, т.к. они являются неотъемлемой частью бизнес — требований.</p>

<p>Роболектрик хорошо подходит для тестирования следующих объектов Android FrameWork’а:</p>

<ul>
  <li>
    <p>Parcelable — нужно проверять корректоность сериализации и восстановления.</p>
  </li>
  <li>
    <p>SQLite — тестирование миграции данных, изменения схем, добавление новых таблиц, корректность выполнения запросов.
Распространенный кейс это проверка баз при обновлении приложения.</p>
  </li>
  <li>
    <p>Shared Preferences - запись и чтение.</p>
  </li>
  <li>
    <p>Intent / Bundle — флаги, с которыми будет запущена следующая Activity или Service.</p>
  </li>
</ul>

<p>В тестовом классе <code class="highlighter-rouge">ru.android2019.testingexample.emailValidator.RobolectricSharedPreferencesHelperTest</code>
Robolectric сам создает для нас <code class="highlighter-rouge">DefaultSharedPreference</code> и можем работать с ним как будто приложение запущено на устройстве.</p>

<p>Для использования Robolectric надо добавить следующие строчки в <code class="highlighter-rouge">build.gradle</code></p>
<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">testImplementation</span> <span class="s1">'org.robolectric:robolectric:4.0.2'</span>
    <span class="c1">//for Robolectric</span>
    <span class="n">testImplementation</span> <span class="s1">'androidx.test:core:1.1.0'</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nd">@Test</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addsDataToSharedPreference</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">Application</span> <span class="n">application</span> <span class="o">=</span> <span class="n">ApplicationProvider</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">();</span>
            <span class="n">mSharedPreferences</span> <span class="o">=</span>  <span class="n">PreferenceManager</span><span class="o">.</span><span class="na">getDefaultSharedPreferences</span><span class="o">(</span><span class="n">application</span><span class="o">);</span>
        <span class="o">...</span>
        <span class="o">}</span>
</code></pre></div></div>

<p>Robolectric может запускать тесты для определенной версии sdk или для ориентации или разрешения экрана, или языка.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@Config</span><span class="o">(</span><span class="n">sdk</span><span class="o">=</span><span class="n">JELLYBEAN_MR1</span><span class="o">,</span>
      <span class="n">qualifiers</span> <span class="o">=</span> <span class="s">"fr-xlarge"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">SandwichTest</span> <span class="o">{</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>Роболектрик не может работать с:</p>
<ul>
  <li>Native кодом - Android native код не может быть исполнен на локальной JVM.</li>
  <li>Вызовами вне процесса - На локально ймашине не запущены Android system services.</li>
</ul>

<p>Роболектрик решает эту проблему с помощью классов, которые называются Shadows.
Каждый Shadow объект может модифицировать или расширять поведение нужного класса в Android OS.
Когда создается объект Android класса, Robolectric ищет соответствующий ему Shadow класс, если находит,
то создает Shadow объект и связывает его с Android обхектом.</p>

<p>Через инструментирование Байт-кода Роболектрик может создавать кросс-платформенную прокси имплементацию, чтобы заместить ею
native код и добавить дополнительное API, чтобы сделать тестирование возможным.</p>

<p>Возьмем класс <code class="highlighter-rouge">ShadowView</code> он является Shadow для класса <code class="highlighter-rouge">View</code> из Андроида. При обращении ко <code class="highlighter-rouge">View</code> внутри Robolectric
теста, будет использован этот класс.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//</span>
<span class="nd">@Implements</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShadowView</span> <span class="o">{</span>
    <span class="nd">@Implementation</span>
      <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">setOnClickListener</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">OnClickListener</span> <span class="n">onClickListener</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">onClickListener</span> <span class="o">=</span> <span class="n">onClickListener</span><span class="o">;</span>
        <span class="n">directly</span><span class="o">().</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="n">onClickListener</span><span class="o">);</span>
      <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Роболектрик лучше не использовать для тестов:</p>
<ul>
  <li>В которых много перемещений между Activity</li>
  <li>В которых применяется много потоков и нужна синхронизация между ними.</li>
</ul>



      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
